name: Deploy to GCP VM with OS Login
on:
  workflow_call:
    secrets:
      GCP_SA_KEY:
        required: true

env:
  PROJECT: "HecBillingCustomer"
  PROJECT_URL: "https://dev.hecbill.hecticus.com"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Set up SBT
      uses: sbt/setup-sbt@v1

        # - name: Notify Slack
        #uses: 8398a7/action-slack@v3
        #with:
        #status: ${{ job.status }}
        #channel: '#deployments'
        #webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        #if: always()

    - name: Build project
      run: |
        cd $PROJECT
        sbt clean compile

    - name: Create distribution package
      run: |
        cd $PROJECT
        sbt universal:packageBin

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hecbillingcustomer-package
        path: ${{ env.PROJECT }}/target/universal/*.zip
        retention-days: 7

    - name: Create distribution package
      run: |
        cd $PROJECT
        sbt universal:packageBin

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hecbilling-package
        path: ${{ env.PROJECT }}/target/universal/*.zip
        retention-days: 7

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: "Build and Deploy"
      run: |
        if [[ $GITHUB_REF_NAME == 'main' ]]; then
          GCP_PROJECT_ID=hecbilling-203521
          GCP_VM_ZONE=us-east1-b
          GCP_VM_NAME=customer-portal-app   
        elif [[ $GITHUB_REF_NAME == 'test-actions' ]]; then
          GCP_PROJECT_ID=hecbilling-203521
          GCP_VM_ZONE=us-east1-b
          GCP_VM_NAME=customer-portal-app   
        else
            echo "Error: Invalid branch name '$GITHUB_REF_NAME'. Valid branches are 'main' and 'test-actions'."
            exit 1
        fi

    - name: Deploy using OS Login
      run: |
        gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
          --zone ${{ secrets.GCP_VM_ZONE }} \
          --project ${{ secrets.GCP_PROJECT_ID }} \
          --command="$(cat << 'EOF'
            #!/bin/bash
            set -e
        
            # Configuration
            DEPLOY_DIR="/opt/hecbillingcustomer"
            APP_DIR="/opt/hecbillingcustomer"
            SERVICE_NAME="hecbillingcustomer"
        
            echo "Starting deployment process..."
        
            # Create deployment directory
            #echo "Setting up deployment directory: $DEPLOY_DIR"
            #sudo mkdir -p $DEPLOY_DIR
            #sudo chown $USER:$USER $DEPLOY_DIR
        
            # Stop existing service
            echo "Stopping existing service: $SERVICE_NAME"
            sudo systemctl stop $SERVICE_NAME || true
        
            # Backup current version
            if [ -d "$DEPLOY_DIR/current" ]; then
              BACKUP_DIR="$DEPLOY_DIR/backup_$(date +%Y%m%d_%H%M%S)"
              echo "Creating backup: $BACKUP_DIR"
              cp -r $DEPLOY_DIR/current $BACKUP_DIR
            else
              echo "No existing deployment found for backup"
            fi
        
            # Update application code
            echo "Updating application code from Git..."
            cd $APP_DIR
            git pull origin main
        
            # Additional build steps if needed
             sbt universal:packageBin
             unzip -o target/universal/*.zip -d $DEPLOY_DIR/
        
            # Restart service
            echo "Restarting service: $SERVICE_NAME"
            sudo systemctl restart $SERVICE_NAME
        
            # Verify deployment
            echo "Verifying deployment..."
            sleep 5
            sudo systemctl status $SERVICE_NAME
        
            echo "âœ… Deployment completed successfully!"
          EOF
        )"
