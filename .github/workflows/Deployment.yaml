name: Deploy to GCP VM with OS Login

on:
  workflow_call:
    secrets:
      GCP_SA_KEY:
        required: true

env:
  PROJECT: "HecBillingCustomer"
  PROJECT_URL: "https://dev.hecbill.hecticus.com"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set GCP env vars
        run: |
          if [[ "$GITHUB_REF_NAME" == "main" ]]; then
            echo "GCP_PROJECT_ID=hecbilling-203521" >> $GITHUB_ENV
            echo "GCP_VM_ZONE=us-east1-b" >> $GITHUB_ENV
            echo "GCP_VM_NAME=customer-portal-app" >> $GITHUB_ENV
          elif [[ "$GITHUB_REF_NAME" == "test-actions" ]]; then
            echo "GCP_PROJECT_ID=hecbilling-203521" >> $GITHUB_ENV
            echo "GCP_VM_ZONE=us-east1-b" >> $GITHUB_ENV
            echo "GCP_VM_NAME=customer-portal-app" >> $GITHUB_ENV
          else
            echo "Error: Invalid branch name '$GITHUB_REF_NAME'. Valid branches are 'main' and 'test-actions'."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Set up SBT
        uses: sbt/setup-sbt@v1

      - name: Build project
        run: |
          cd "$PROJECT"
          sbt clean compile

      - name: Create distribution package
        run: |
          cd "$PROJECT"
          sbt universal:packageBin

      - name: Upload build artifacts (hecbillingcustomer)
        uses: actions/upload-artifact@v4
        with:
          name: hecbillingcustomer-package
          path: ${{ env.PROJECT }}/target/universal/*.zip
          retention-days: 7

      # (si el segundo upload es realmente necesario, mantenlo;
      # si no, puedes borrarlo para evitar duplicados)
      - name: Upload build artifacts (hecbilling)
        uses: actions/upload-artifact@v4
        with:
          name: hecbilling-package
          path: ${{ env.PROJECT }}/target/universal/*.zip
          retention-days: 7

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Deploy to GCP VM
        run: |
          gcloud compute ssh "$GCP_VM_NAME" \
            --zone "$GCP_VM_ZONE" \
            --project "$GCP_PROJECT_ID" \
            --command='
            #!/bin/bash
            set -e

            # Configuration
            DEPLOY_DIR="/opt/hecbillingcustomer"
            APP_DIR="/opt/hecbillingcustomer"
            SERVICE_NAME="hecbillingcustomer"

            echo "Starting deployment process..."

            # Stop existing service
            echo "Stopping existing service: $SERVICE_NAME"
            sudo systemctl stop "$SERVICE_NAME" || true

            # Backup current version
            if [ -d "$DEPLOY_DIR/current" ]; then
              BACKUP_DIR="$DEPLOY_DIR/backup_$(date +%Y%m%d_%H%M%S)"
              echo "Creating backup: $BACKUP_DIR"
              cp -r "$DEPLOY_DIR/current" "$BACKUP_DIR"
            else
              echo "No existing deployment found for backup"
            fi

            # Update application code
            echo "Updating application code from Git..."
            cd "$APP_DIR"
            git pull origin main

            # Additional build steps
            sbt universal:packageBin
            unzip -o target/universal/*.zip -d "$DEPLOY_DIR/"

            # Restart service
            echo "Restarting service: $SERVICE_NAME"
            sudo systemctl restart "$SERVICE_NAME"

            # Verify deployment
            echo "Verifying deployment..."
            sleep 5
            sudo systemctl status "$SERVICE_NAME"

            echo "âœ… Deployment completed successfully!"
            '

