name: Deploy to GCP VM with OS Login

on:
  workflow_call:
    secrets:
      GCP_SA_KEY:
        required: true

env:
  PROJECT: "HecBillingCustomer"
  PROJECT_URL: "https://dev.hecbill.hecticus.com"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set GCP env vars
        run: |
          if [[ "$GITHUB_REF_NAME" == "main" || "$GITHUB_REF_NAME" == "test-actions" ]]; then
            echo "GCP_PROJECT_ID=hecbilling-203521" >> $GITHUB_ENV
            echo "GCP_VM_ZONE=us-east1-b" >> $GITHUB_ENV
            echo "GCP_VM_NAME=customer-portal-app" >> $GITHUB_ENV
          else
            echo "Error: Invalid branch name '$GITHUB_REF_NAME'. Valid branches are 'main' and 'test-actions'."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Set up SBT
        uses: sbt/setup-sbt@v1

      - name: Build project
        run: |
          cd "$PROJECT"
          sbt clean compile

      - name: Create distribution package
        run: |
          cd "$PROJECT"
          sbt universal:packageBin

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hecbillingcustomer-package
          path: ${{ env.PROJECT }}/target/universal/*.zip
          retention-days: 7

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          export_environment_variables: true

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          export_default_credentials: false

      - name: Configure SSH for OS Login
        run: |
          # Generate SSH key if not exists
          mkdir -p ~/.ssh
          if [ ! -f ~/.ssh/google_compute_engine ]; then
            ssh-keygen -t rsa -f ~/.ssh/google_compute_engine -q -N ""
          fi
          
          # Get service account email
          #SERVICE_ACCOUNT_EMAIL=$(echo '${{ secrets.SERVICE_ACCOUNT_EMAIL }}')
          SERVICE_ACCOUNT_EMAIL=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.client_email')
          echo "Service Account: $SERVICE_ACCOUNT_EMAIL" 
         
          # Get VM external IP
          VM_IP=$(gcloud compute instances describe ${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_VM_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "VM IP: $VM_IP"

      - name: Deploy to GCP VM
        run: |
          # Get service account email and format for OS Login
          SERVICE_ACCOUNT_EMAIL=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.client_email')
          OS_LOGIN_USER="$(echo $SERVICE_ACCOUNT_EMAIL | tr '@' '_' | tr '.' '_')"
          #OS_LOGIN_USER="$(echo '{{ secrets.SERVICE_ACCOUNT_EMAIL }}' | tr '@' '_' | tr '.' '_')"
          

          echo "Using OS Login user: $OS_LOGIN_USER"
          
          # Get VM external IP
          VM_IP=$(gcloud compute instances describe ${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_VM_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          # SSH using OS Login with deployment commands
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/google_compute_engine \
              $OS_LOGIN_USER@$VM_IP << 'EOF'
            #!/bin/bash
            set -e
            
            # Configuration
            DEPLOY_DIR="/opt/hecbillingcustomer"
            APP_DIR="/opt/hecbillingcustomer"
            SERVICE_NAME="hecbillingcustomer"

            echo "Starting deployment process..."

            # Stop existing service
            echo "Stopping existing service: $SERVICE_NAME"
            sudo systemctl stop "$SERVICE_NAME" || true

            # Backup current version
            if [ -d "$DEPLOY_DIR/current" ]; then
              BACKUP_DIR="$DEPLOY_DIR/backup_$(date +%Y%m%d_%H%M%S)"
              echo "Creating backup: $BACKUP_DIR"
              cp -r "$DEPLOY_DIR/current" "$BACKUP_DIR"
            else
              echo "No existing deployment found for backup"
            fi

            # Update application code
            echo "Updating application code from Git..."
            cd "$APP_DIR"
            git pull origin main

            # Additional build steps
            echo "Building application with SBT..."
            sbt universal:packageBin
            
            echo "Extracting distribution package..."
            # Find the latest zip file
            LATEST_ZIP=$(ls -t target/universal/*.zip | head -1)
            if [ -n "$LATEST_ZIP" ]; then
              echo "Found package: $LATEST_ZIP"
              # Clean previous deployment
              sudo rm -rf "$DEPLOY_DIR/current" || true
              # Extract new version
              unzip -o "$LATEST_ZIP" -d "$DEPLOY_DIR/"
              # Create symlink or rename
              EXTRACTED_DIR=$(basename "$LATEST_ZIP" .zip)
              mv "$DEPLOY_DIR/$EXTRACTED_DIR" "$DEPLOY_DIR/current"
            else
              echo "Error: No zip file found in target/universal/"
              exit 1
            fi

            # Set proper permissions
            sudo chown -R root:root "$DEPLOY_DIR/current"
            sudo chmod -R 755 "$DEPLOY_DIR/current/bin"

            # Restart service
            echo "Restarting service: $SERVICE_NAME"
            sudo systemctl restart "$SERVICE_NAME"

            # Verify deployment
            echo "Verifying deployment..."
            sleep 5
            sudo systemctl status "$SERVICE_NAME" --no-pager

            echo "âœ… Deployment completed successfully!"
          EOF
